<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Immigration Services – Sign-Up</title>
  <style>
    :root{--brand:#DD1C23;--ink:#1D1C20;--muted:#6b7280;--bg:#f9fafb;--card:#ffffff}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:920px;margin:40px auto;padding:24px}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:24px;box-shadow:0 10px 20px rgba(0,0,0,.04)}
    h1{font-size:28px;margin:0 0 8px}
    p.lead{color:var(--muted);margin-top:0}

    /* progress */
    .progress{display:flex;gap:8px;margin:20px 0 28px}
    .progress .dot{flex:1;height:6px;background:#e5e7eb;border-radius:999px;position:relative;overflow:hidden}
    .progress .dot.active::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,var(--brand),#ff8a85)}

    /* steps */
    .step{display:none}
    .step.active{display:block}
    .step h2{font-size:20px;margin:0 0 12px}
    .grid{display:grid;gap:16px}
    .grid.two{grid-template-columns:1fr}
    @media (min-width:720px){.grid.two{grid-template-columns:repeat(2,minmax(0,1fr))}}

    fieldset{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:0}
    legend{padding:0 6px;color:var(--muted)}

    label{display:block;font-weight:600;margin:4px 0 6px}
    .hint{color:var(--muted);font-size:12px;margin-top:4px}
    input[type=text],input[type=email],input[type=tel],input[type=number],select,textarea{width:100%;padding:12px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;outline:none;height:44px}
    select{appearance:none;background-image:linear-gradient(45deg,transparent 50%,#999 50%),linear-gradient(135deg,#999 50%,transparent 50%),linear-gradient(to right,#fff,#fff);background-position:calc(100% - 20px) calc(1em - 2px),calc(100% - 15px) calc(1em - 2px),100% 0;background-size:5px 5px,5px 5px,2.5em 2.5em;background-repeat:no-repeat}

    .options{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid #d1d5db;padding:10px 12px;border-radius:999px;cursor:pointer;background:#fff}
    .chip input{accent-color:var(--brand)}

    .actions{display:flex;justify-content:space-between;margin-top:20px}
    button{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn{background:var(--brand);color:#fff;text-transform:uppercase;font-size:12px;letter-spacing:1px}
    .btn.secondary{background:#1118270d;color:#111827}

    .summary{background:#fff;border:1px dashed #e5e7eb;border-radius:12px;padding:16px}
    .group-title{font-size:14px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.02em;margin:4px 0}
    .hidden{display:none !important}
    .error-banner{background:#fff5f5;border:1px solid var(--brand);color:var(--brand);padding:10px 12px;border-radius:10px;margin:8px 0 12px}
    .invalid{border-color:var(--brand)!important}
    .group-error{outline:2px solid var(--brand);outline-offset:2px;border-radius:12px;padding:6px}
    .error-msg{color:var(--brand);font-size:12px;margin-top:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Get Started</h1>
      <p class="lead">Answer a few questions so we can set up the right immigration support for you.</p>

      <div class="progress" id="progress">
        <div class="dot active"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>

      <form id="signupForm" novalidate>
        <!-- Step 1: Service selection -->
        <section class="step active" data-step="1">
          <h2>Step 1 · Choose your service</h2>
          <fieldset>
            <legend>Select one</legend>
            <div class="grid two">
              <div style="grid-column:1/-1"><h3 class="group-title">Family Petition</h3></div>
              <label class="chip"><input type="radio" name="service" value="i130" required> I-130 · Petition for Relative</label>
              <label class="chip"><input type="radio" name="service" value="i129f"> I-129F · Petition for Fiancé(e)</label>

              <div style="grid-column:1/-1;margin-top:8px"><h3 class="group-title">Adjustment of Status</h3></div>
              <label class="chip"><input type="radio" name="service" value="i485_package"> I-485 · Adjustment Package</label>
              <label class="chip"><input type="radio" name="service" value="i360_i485"> I-360 / I-485 · VAWA Adjustment Package</label>

              <div style="grid-column:1/-1;margin-top:8px"><h3 class="group-title">Other Services</h3></div>
              <label class="chip"><input type="radio" name="service" value="i751"> I-751 · Removal of Conditions of Residence</label>
              <label class="chip"><input type="radio" name="service" value="i539"> I-539 · Extend/Change Nonimmigrant Status</label>
              <label class="chip"><input type="radio" name="service" value="i589_i765"> I-589 / I-765 · Asylum Package</label>
              <label class="chip"><input type="radio" name="service" value="i765_renewal"> I-765 · Renewal of Work Authorization</label>
              <label class="chip"><input type="radio" name="service" value="i918"> I-918 · U Visa Nonimmigrant Status</label>
              <label class="chip"><input type="radio" name="service" value="n400_n600"> N-400 · Naturalization / N-600 · Citizenship</label>
            </div>
          </fieldset>
          <div class="actions">
            <span></span>
            <button type="button" class="btn" data-next>Next</button>
          </div>
        </section>

        <!-- Step 2: Details (always shown) -->
        <section class="step" data-step="2">
          <h2>Step 2 · Details</h2>

          <!-- Adjustment package: approved petition? (specific + none) -->
          <div id="adjustment-details" class="hidden" style="margin-bottom:12px">
            <label>Which petition is approved (if any)?</label>
            <div class="options">
              <label class="chip"><input type="radio" name="adjustment_type" value="i130_approved"> I-130 Approved</label>
              <label class="chip"><input type="radio" name="adjustment_type" value="i140_approved"> I-140 Approved</label>
              <label class="chip"><input type="radio" name="adjustment_type" value="asylum_approved"> Asylum Approved</label>
              <label class="chip"><input type="radio" name="adjustment_type" value="none"> No approved petition yet</label>
            </div>
          </div>

          <!-- VAWA child radios (only for VAWA Adjustment) -->
          <div id="vawa-child" class="hidden" style="margin-bottom:12px">
            <label>Who is included in this VAWA Adjustment?</label>
            <div class="options">
              <label class="chip"><input type="radio" name="vawa_party" value="principal_only"> Principal Only</label>
              <label class="chip"><input type="radio" name="vawa_party" value="principal_child"> Principal + Child</label>
            </div>
          </div>

          <!-- Party size ALWAYS visible (defaults/limits adapt to service) -->
          <div id="party-wrapper">
            <label id="party-label">How many applicants are included for this service?</label>
            <input type="number" name="party_count" id="party-count" min="1" max="5" value="1" required />
            <p class="hint" id="party-hint">For most services this is 1. Some family or adjustment packages may include more than one person.</p>
          </div>

          <div class="actions">
            <button type="button" class="btn secondary" data-back>Back</button>
            <button type="button" class="btn" data-next>Next</button>
          </div>
        </section>

        <!-- Step 3: Contact info -->
        <section class="step" data-step="3">
          <h2>Step 3 · Your contact details</h2>
          <div class="grid two">
            <div>
              <label>Full name</label>
              <input type="text" name="full_name" required />
            </div>
            <div>
              <label>Email</label>
              <input type="email" name="email" required />
            </div>
            <div>
              <label>Phone</label>
              <input type="tel" name="phone" required />
            </div>
            <div>
              <label>Preferred contact method</label>
              <select name="contact_method" required>
                <option>Email</option>
                <option>Phone</option>
                <option>WhatsApp</option>
              </select>
            </div>
          </div>
          <label><input type="checkbox" name="consent" required> I confirm that I’ve read and agree to the terms and conditions.</label>
          <div class="actions">
            <button type="button" class="btn secondary" data-back>Back</button>
            <button type="button" class="btn" data-next>Review</button>
          </div>
        </section>

        <!-- Step 4: Review -->
        <section class="step" data-step="4">
          <h2>Step 4 · Review</h2>
          <div class="summary" id="summary"></div>
          <div class="actions">
            <button type="button" class="btn secondary" data-back>Back</button>
            <button type="submit" class="btn">Submit</button>
          </div>
        </section>
      </form>
    </div>
  </div>

  <script>
    // ---- State & helpers
    const form = document.getElementById('signupForm');
    const steps = [...document.querySelectorAll('.step')];
    const dots = [...document.querySelectorAll('#progress .dot')];
    let current = 0;
    // dynamic flow: default 4 steps; for Other Services use 3 steps (skip Details)
    let flow = [0,1,2,3];
    const otherServices = new Set(['i129f','i751','i539','i589_i765','i765_renewal','i918','n400_n600']);
    const isOtherService = (svc) => otherServices.has(svc||getService());

    function computeFlowAndTitles(){
      const svc = getService();
      const contactH2 = document.querySelector('section[data-step="3"] h2');
      const reviewH2 = document.querySelector('section[data-step="4"] h2');
      // Reset dots visibility
      dots.forEach(d=>d.classList.remove('hidden'));
      if(isOtherService(svc)){
        flow = [0,2,3];
        // Hide the second dot (Details) for 3-step flow
        if(dots[1]) dots[1].classList.add('hidden');
        if(contactH2) contactH2.textContent = 'Step 2 · Your contact details';
        if(reviewH2) reviewH2.textContent = 'Step 3 · Review';
      } else {
        flow = [0,1,2,3];
        if(contactH2) contactH2.textContent = 'Step 3 · Your contact details';
        if(reviewH2) reviewH2.textContent = 'Step 4 · Review';
      }
      // refresh progress state for current index
      const visibleDots = dots.filter(d=>!d.classList.contains('hidden'));
      visibleDots.forEach((d,idx)=>d.classList.toggle('active', idx<=current));
    }

    const getService = () => (form.querySelector('input[name="service"]:checked')||{}).value||'';

    // Single declaration for service inputs
    const serviceInputs = document.querySelectorAll('input[name="service"]');

    function updateAdjustmentVisibility(){
      const service = getService();

      // Show Adjustment radios only for I-485 package (not for VAWA/Fiancé)
      const adjBlock = document.getElementById('adjustment-details');
      const showAdjRadios = service==='i485_package';
      adjBlock.classList.toggle('hidden', !showAdjRadios);
      adjBlock.querySelectorAll('input[name="adjustment_type"]').forEach(r=>{
        if(showAdjRadios){ r.setAttribute('required',''); }
        else { r.removeAttribute('required'); r.checked=false; }
      });

      // VAWA specific radios
      const vawaBlock = document.getElementById('vawa-child');
      const vawaRadios = document.querySelectorAll('input[name="vawa_party"]');
      const partyWrapper = document.getElementById('party-wrapper');
      const partyLabel = document.getElementById('party-label');
      const partyHint = document.getElementById('party-hint');
      const partyCount = document.getElementById('party-count');

      if(service==='i360_i485'){
        // Show VAWA radios, hide numeric input, sync party_count from radios
        vawaBlock.classList.remove('hidden');
        vawaRadios.forEach(r=>r.setAttribute('required',''));
        partyWrapper.classList.add('hidden');
        partyCount.removeAttribute('required');
        const selected = document.querySelector('input[name="vawa_party"]:checked');
        partyCount.value = selected && selected.value==='principal_child' ? 2 : 1; // default principal only
      } else {
        // Hide VAWA radios and clear selection/required
        vawaBlock.classList.add('hidden');
        vawaRadios.forEach(r=>{ r.removeAttribute('required'); r.checked=false; });
        // Fiancé flow skips Step 2 entirely, so hide numeric and ensure not required
        if(service==='i129f'){
          partyWrapper.classList.add('hidden');
          partyCount.removeAttribute('required');
          partyCount.value = 1; // always 1 for fiancé(e)
        } else {
          // Show numeric input with proper constraints
          partyWrapper.classList.remove('hidden');
          partyCount.setAttribute('required','');
        }
      }

      // Numeric party size guidance (applies when numeric field is visible)
      if(service==='i130'){
        partyLabel.textContent = 'How many beneficiaries are included for this I-130?';
        partyHint.textContent = 'Usually 1. If filing for multiple beneficiaries, set the count (max 3).';
        partyCount.min = 1; partyCount.max = 3; if(+partyCount.value<1) partyCount.value = 1;
      } else if(service==='i485_package'){
        partyLabel.textContent = 'How many applicants are included in this Adjustment package?';
        partyHint.textContent = 'Commonly 1 or 2 (e.g., principal + spouse).';
        partyCount.min = 1; partyCount.max = 2; if(+partyCount.value>2) partyCount.value = 2;
      } else if(service!=='i360_i485' && service!=='i129f'){
        partyLabel.textContent = 'How many applicants are included for this service?';
        partyHint.textContent = 'Most services are single-applicant. Set to 1 unless otherwise needed.';
        partyCount.min = 1; partyCount.max = 1; partyCount.value = 1;
      }
    }

    // FIX: single forEach (remove accidental chaining that caused SyntaxError)
    serviceInputs.forEach(input => input.addEventListener('change', ()=>{ computeFlowAndTitles(); updateAdjustmentVisibility(); }));

    // Sync VAWA radios to party_count for accurate summary/back-end
    document.addEventListener('change', (e)=>{
      if(e.target && e.target.name==='vawa_party'){
        const partyCount = document.getElementById('party-count');
        partyCount.value = e.target.value==='principal_child' ? 2 : 1;
      }
    });

    function show(i){
      const stepIndex = flow[i];
      steps.forEach((s,idx)=>s.classList.toggle('active', idx===stepIndex));
      current=i;
      const visibleDots = dots.filter(d=>!d.classList.contains('hidden'));
      visibleDots.forEach((d,idx)=>d.classList.toggle('active', idx<=i));
      if(stepIndex===1) updateAdjustmentVisibility();
      if(stepIndex===3) renderSummary();
    }

    function next(){
      const active = steps[current];
      const required = [...active.querySelectorAll('[required]')];
      for(const el of required){
        if((el.type==='radio' || el.type==='checkbox')){
          const groupChecked = active.querySelector(`[name="${el.name}"]:checked`);
          if(!groupChecked){ alert('Please complete all required fields.'); return; }
        } else if(!el.value){ alert('Please complete all required fields.'); return; }
      }
      if(current < flow.length-1) show(current+1);
    }

    function back(){ if(current>0) show(current-1); }

    function showBannerIn(stepEl, message){
      var banner = stepEl.querySelector('.error-banner');
      if(!banner){
        banner = document.createElement('div');
        banner.className = 'error-banner';
        var actions = stepEl.querySelector('.actions');
        stepEl.insertBefore(banner, actions || stepEl.firstChild);
      }
      banner.textContent = message;
    }

    function clearErrors(scope){
      (scope || document).querySelectorAll('.invalid').forEach(function(e){ e.classList.remove('invalid'); });
      (scope || document).querySelectorAll('.group-error').forEach(function(e){ e.classList.remove('group-error'); });
      (scope || document).querySelectorAll('.error-msg').forEach(function(e){ e.remove(); });
      (scope || document).querySelectorAll('.error-banner').forEach(function(e){ e.remove(); });
    }

    function addError(el, msg){
      if(el.type==='radio' || el.type==='checkbox'){
        var group = el.closest('.options') || el.closest('fieldset') || el.parentElement;
        if(group){
          group.classList.add('group-error');
          if(!group.querySelector('.error-msg')){
            var m = document.createElement('div');
            m.className='error-msg';
            m.textContent = msg;
            group.appendChild(m);
          }
        }
      } else {
        el.classList.add('invalid');
        if(!el.nextElementSibling || !el.nextElementSibling.classList.contains('error-msg')){
          var mm = document.createElement('div');
          mm.className='error-msg';
          mm.textContent = msg;
          el.insertAdjacentElement('afterend', mm);
        }
      }
    }

    function validateContainer(container){
      var ok = true;
      var processed = new Set();
      var nodes = [].slice.call(container.querySelectorAll('[required]'));
      for(var i=0;i<nodes.length;i++){
        var el = nodes[i];
        if(el.type==='radio' || el.type==='checkbox'){
          if(processed.has(el.name)) continue;
          processed.add(el.name);
          var checked = container.querySelector('[name="' + el.name + '"]:checked');
          if(!checked){ ok=false; addError(el, 'This selection is required.'); }
        } else {
          if(!el.value || (el.type==='email' && (!el.value.includes('@') || !el.value.includes('.')))){
            ok=false; addError(el, el.type==='email' ? 'Enter a valid email.' : 'This field is required.');
          }
        }
      }
      return ok;
    }

    function nextEnhanced(){
      var active = steps[flow[current]];
      clearErrors(active);
      var stepValid = validateContainer(active);
      if(!stepValid){
        showBannerIn(active, 'Please complete the highlighted fields.');
        return;
      }
      var isPreReview = current === flow.length - 2;
      if(isPreReview){
        clearErrors(form);
        var allValid = validateContainer(form);
        if(!allValid){
          var firstBad = form.querySelector('.invalid, .group-error');
          if(firstBad){
            var stepEl = firstBad.closest('.step');
            var idxInSteps = steps.indexOf(stepEl);
            var flowIdx = flow.indexOf(idxInSteps);
            if(flowIdx !== -1){ current = flowIdx; show(current); }
            showBannerIn(stepEl, 'Please complete the highlighted fields.');
          }
          return;
        }
      }
      if(current < flow.length-1) show(current+1);
    }

    document.querySelectorAll('[data-next]').forEach(function(b){ b.addEventListener('click', nextEnhanced); });
    document.querySelectorAll('[data-back]').forEach(b=>b.addEventListener('click',back));

    function renderSummary(){
      const summary = document.getElementById('summary');
      const data = new FormData(form);
      const obj = Object.fromEntries([...data.entries()]);

      const serviceLabels = {
        i130: 'I-130 · Petition for Relative',
        i129f: 'I-129F · Petition for Fiancé(e)',
        i485_package: 'I-485 · Adjustment Package',
        i360_i485: 'I-360 / I-485 · VAWA Adjustment Package',
        i751: 'I-751 · Removal of Conditions of Residence',
        i539: 'I-539 · Extend/Change Nonimmigrant Status',
        i589_i765: 'I-589 / I-765 · Asylum Package',
        i765_renewal: 'I-765 · Renewal of Work Authorization',
        i918: 'I-918 · U Visa Nonimmigrant Status',
        n400_n600: 'N-400 · Naturalization / N-600 · Citizenship'
      };

      const approvedMap = { i130_approved: 'I-130 Approved', i140_approved: 'I-140 Approved', asylum_approved: 'Asylum Approved', none: 'No approved petition yet' };
      const approvedText = approvedMap[obj.adjustment_type];
      const vawaText = obj.service==='i360_i485' ? (obj.vawa_party==='principal_child' ? 'Principal + Child' : 'Principal Only') : null;

      const peopleLine = `Party size: ${obj.party_count||1}`;
      const contactLine = `${obj.full_name||'-'} · ${obj.email||'-'} · ${obj.phone||''}`;

      summary.innerHTML = `
        <div><strong>Service:</strong> ${serviceLabels[obj.service]||'-'}</div>
        ${obj.service==='i485_package' && approvedText ? `<div><strong>Approved Petition:</strong> ${approvedText}</div>` : ''}
        ${vawaText!==null ? `<div><strong>Includes:</strong> ${vawaText}</div>` : ''}
        <div><strong>People:</strong> ${peopleLine}</div>
        <div><strong>Contact:</strong> ${contactLine}</div>`;
    }

    // init
    document.addEventListener('DOMContentLoaded', ()=>{ computeFlowAndTitles(); updateAdjustmentVisibility(); });

    form.addEventListener('submit', e=>{
      e.preventDefault();
      alert('Form submitted!');
      form.reset();
      show(0);
    });

    // ------------------------------------------------------------
    // Smoke tests (manual): run window.runSmokeTests() in console
    // ------------------------------------------------------------
    window.runSmokeTests = function(){
      try{
        console.assert(document.querySelectorAll('input[name="service"]').length>0, 'service inputs present');
        console.assert(typeof computeFlowAndTitles==='function', 'computeFlowAndTitles exists');
        console.assert(typeof updateAdjustmentVisibility==='function', 'updateAdjustmentVisibility exists');
        console.assert(Array.isArray(flow) && flow.length>=3, 'flow initialized');

        // Additional tests: clearErrors removes errors in a scoped container
        const tmp = document.createElement('div');
        tmp.innerHTML = '<div class="invalid"></div><div class="group-error"></div><div class="error-msg"></div><div class="error-banner"></div>';
        clearErrors(tmp);
        console.assert(!tmp.querySelector('.invalid') && !tmp.querySelector('.group-error') && !tmp.querySelector('.error-msg') && !tmp.querySelector('.error-banner'), 'clearErrors removes classes/elements');

        // Flow switching test: i129f => 3 steps, i485_package => 4 steps
        const prev = form.querySelector('input[name="service"]:checked');
        const f129 = form.querySelector('input[name="service"][value="i129f"]');
        if(f129){ f129.checked = true; computeFlowAndTitles(); console.assert(flow.length===3, 'i129f switches to 3-step flow'); }
        const f485 = form.querySelector('input[name="service"][value="i485_package"]');
        if(f485){ f485.checked = true; computeFlowAndTitles(); console.assert(flow.length===4, 'i485 keeps 4-step flow'); }
        if(prev){ prev.checked = true; computeFlowAndTitles(); }

        console.log('%cSmoke tests passed.', 'color: #10b981');
      }catch(err){ console.error('Smoke tests error:', err); }
    };
  </script>
</body>
</html>
